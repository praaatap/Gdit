name: Build & Release EXE

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v3.0.2, etc.
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  build-executables:
    name: ðŸ”¨ Build Windows Executable & Installer
    runs-on: windows-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ðŸ“š Install dependencies
        run: npm ci
      
      - name: ðŸ”¨ Build TypeScript
        run: npm run build
      
      - name: ðŸ“¦ Install pkg
        run: npm install -g pkg
      
      - name: ðŸ—ï¸ Build Windows Executable
        run: |
          pkg . --targets node18-win-x64 --output gdit.exe
        
      - name: ðŸ“‹ Verify executable
        run: |
          ./gdit.exe --version
        shell: pwsh

      - name: ðŸ“‹ Get version from tag
        id: get_version
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: ðŸ–¼ï¸ Convert logo to ICO format
        run: |
          # Install ImageMagick for image conversion
          choco install imagemagick -y
          
          # Convert JPG to ICO (multiple sizes for best quality)
          if (Test-Path "assets/icon.jpg") {
            magick convert "assets/icon.jpg" -define icon:auto-resize=256,128,64,48,32,16 "assets/icon.ico"
            Write-Host "âœ… Icon converted successfully"
          } elseif (Test-Path "assets/icon.png") {
            magick convert "assets/icon.png" -define icon:auto-resize=256,128,64,48,32,16 "assets/icon.ico"
            Write-Host "âœ… Icon converted successfully"
          } else {
            Write-Host "âš ï¸ No icon found, installer will use default icon"
          }
        shell: pwsh

      - name: ðŸ“ Update installer version
        run: |
          $issPath = "installer/gdit-installer.iss"
          $content = Get-Content $issPath -Raw
          $content = $content -replace '#define MyAppVersion ".*"', '#define MyAppVersion "${{ steps.get_version.outputs.VERSION }}"'
          Set-Content $issPath $content
        shell: pwsh

      - name: ðŸ“¦ Build Windows Installer
        run: |
          # Install Inno Setup
          choco install innosetup -y
          
          # Create release directory
          New-Item -ItemType Directory -Path "release" -Force
          
          # Check if icon exists
          if (Test-Path "assets/icon.ico") {
            & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer/gdit-installer.iss"
          } else {
            # Build without icon
            $issContent = Get-Content "installer/gdit-installer.iss" -Raw
            $issContent = $issContent -replace 'SetupIconFile=.*', '; SetupIconFile removed'
            $issContent = $issContent -replace 'UninstallDisplayIcon=.*', '; UninstallDisplayIcon removed'
            Set-Content "installer/gdit-installer-noicon.iss" $issContent
            & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer/gdit-installer-noicon.iss"
          }
        shell: pwsh

      - name: ï¿½ Prepare release files
        run: |
          # Create release directory if not exists
          New-Item -ItemType Directory -Path "release" -Force
          
          # Copy and rename portable exe
          Copy-Item "gdit.exe" "release/gdit-${{ steps.get_version.outputs.VERSION }}-windows-x64-portable.exe"
          
          Write-Host "ðŸ“¦ Release files prepared:"
          Get-ChildItem "release" | ForEach-Object { Write-Host "  - $($_.Name)" }
        shell: pwsh
      
      - name: ðŸ“¤ Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gdit-release-files
          path: release/*.exe
          retention-days: 30

  create-release:
    name: ðŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-executables
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download release files
        uses: actions/download-artifact@v4
        with:
          name: gdit-release-files
          path: ./release
      
      - name: ðŸ“‹ List release files
        run: ls -la ./release/
      
      - name: ðŸ“‹ Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¢ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: gdit ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ðŸš€ gdit ${{ steps.get_version.outputs.VERSION }}
            
            Git-like version control for Google Drive. Stage, commit, and sync files using familiar Git commands.
            
            ---
            
            ### ðŸ“¥ Downloads
            
            | Type | File | Description |
            |------|------|-------------|
            | ðŸ”§ **Installer (Recommended)** | [gdit-setup.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/gdit-${{ steps.get_version.outputs.VERSION }}-windows-x64-setup.exe) | Windows installer with PATH integration |
            | ðŸ“¦ **Portable** | [gdit-portable.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/gdit-${{ steps.get_version.outputs.VERSION }}-windows-x64-portable.exe) | Standalone executable (no install required) |
            
            ---
            
            ### ðŸ”§ Installation Options
            
            #### Option 1: Windows Installer (Recommended)
            1. Download `gdit-*-setup.exe`
            2. Run the installer
            3. Check "Add gdit to system PATH"
            4. Open a new terminal and run `gdit --help`
            
            #### Option 2: Portable Executable
            1. Download `gdit.exe`
            2. Place it in a folder (e.g., `C:\Tools\gdit\`)
            3. Add the folder to your system PATH manually
            4. Run `gdit --help` in terminal
            
            #### Option 3: npm (requires Node.js)
            ```bash
            npm install -g gdit
            ```
            
            ---
            
            ### ðŸš€ Quick Start
            ```bash
            # Setup Google API credentials
            gdit setup-creds
            
            # Login to Google
            gdit login
            
            # Initialize a repository
            gdit init
            
            # Add and commit files
            gdit add .
            gdit commit -m "Initial commit"
            
            # Push to Google Drive
            gdit push
            ```
            
            ---
            
            ### âœ¨ What's New
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
          files: ./release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

